
@{
    ViewBag.Title = Model.Name;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@using COF.BusinessLogic.Models.RawMaterial;
@model RawMaterialDetailModel



<section class="content-header">
    <h1>
        @Model.Name
    </h1>

    <ol class="breadcrumb">
        <li><a href="/bang-dieu-khien"><i class="fa fa-dashboard"></i> Trang chủ</a></li>
        <li><a href="/nguyen-lieu">Nguyên liệu</a></li>
        <li class="/nguyen-lieu/@Model.Id">@Model.Name</li>
    </ol>

</section>

<section class="content">
    <div class="row">
        <div class="col-xs-12">
            <div class="box">
                <div class="box-body">
                    <div id="tableContent" class="box-body table-responsive">

                        <div class="nav-tabs-custom">


                            <ul class="nav nav-tabs">
                                <li class="active">
                                    <a href="#tab_mainInfo"
                                       data-id="" class="shop-tab" data-toggle="tab" aria-expanded="true">Thông tin chính</a>
                                </li>
                                <li>
                                    <a href="#tab_transactionHistory" id="tab_transactionHistory_huhu"
                                       data-id="" class="shop-tab" data-toggle="tab" aria-expanded="true">Lịch sử</a>
                                </li>
                            </ul>



                            <div class="tab-content">
                                <div class="tab-pane active" id="tab_mainInfo">
                                    <div class="form-horizontal">
                                        <div class="box-body">
                                            <div class="form-group">
                                                <input id="txtHiddenId" value="0" hidden type="text" />
                                                <label for="txtName" class="col-sm-2 control-label">Tên</label>
                                                <div class="col-sm-10">
                                                    <input type="text"  class="form-control" id="txtName" placeholder="Nhập tên danh mục ...." value="@Model.Name">
                                                </div>
                                            </div>

                                            <div class="form-group">

                                                <label for="txtName" class="col-sm-2 control-label">Đơn vị</label>
                                                <div class="col-sm-10">

                                                    @{ 
                                                        var units = TempData["Units"] as List<RawMaterialUnitModel>;
                                                    }
                                                    <select class="form-control" id="ddlRawMaterialUnits">
                                                        @{
                                                            foreach (var unit in units)
                                                            {
                                                                if (unit.Id == Model.RawMaterialUnitId)
                                                                {
                                                                    <option value="@unit.Id" selected>
                                                                        @unit.Name
                                                                    </option>
                                                                }
                                                                else
                                                                {
                                                                    <option value="@unit.Id">
                                                                        @unit.Name
                                                                    </option>
                                                                }
                                                            }
                                                        }
                                                    </select>
                                                </div>
                                            </div>

                                            <div class="form-group">
                                                <label for="txtDescription" class="col-sm-2 control-label">Mô tả</label>
                                                <div class="col-sm-10">
                                                    <textarea  class="form-control" id="txtDescription" placeholder="Nhập mô tả thêm ....">@Model.Description</textarea>
                                                </div>
                                            </div>

                                            <br />

                                            <div style="float:right">
                                                <button type="button" class="btn bg-olive margin" id="btnSave">Lưu</button>
                                 
                                            </div>

                                        </div>
                                    </div>
                                </div>
                                <!-- /.tab-pane -->
                                <div class="tab-pane" id="tab_transactionHistory">
                                    <div style="background-color:white" class="col-md-12 col-sm-12 col-xs-12 form-group pull-right top_search well well-sm fillter searchForm">

                                        <div class="form-row col-md-12" style="margin-top:15px">
                                            <div class="col-md-3 col-xs-12">
                                                <div class="form-group">
                                                    <label>Từ : </label>

                                                    <div class="input-group date">
                                                        <div class="input-group-addon">
                                                            <i class="fa fa-calendar"></i>
                                                        </div>
                                                        <input type="text" data-date-format="dd-mm-yyyy" class="form-control pull-right" id="fromDate">
                                                    </div>
                                                    <!-- /.input group -->

                                                    <label> Đến :</label>

                                                    <div class="input-group date">
                                                        <div class="input-group-addon">
                                                            <i class="fa fa-calendar"></i>
                                                        </div>
                                                        <input type="text" data-date-format="dd-mm-yyyy" class="form-control pull-right" id="toDate">
                                                    </div>
                                                </div>

                                            </div>
                                            <div class="col-md-3 col-xs-12">
                                                <div class="form-group">
                                                    <label>Loại điều chỉnh : </label>

                                                    <div class="form-group">
                                                        <select class="form-control" id="ddlInputType">
                                                            <option value="">
                                                                -- Tất cả --
                                                            </option>
                                                            <option value="0">
                                                                Nhập hàng
                                                            </option>
                                                            <option value="1">
                                                                Điều chỉnh tồn kho
                                                            </option>
                                                            <option value="2">
                                                                Tự động trừ
                                                            </option>
                                                        </select>
                                                    </div>

                                                </div>

                                            </div>
                                            <br />

                                            <div class="col-md-12 col-xs-12">
                                                <div class="form-group">
                                                    <button class="btn btn-success" id="btnSearch" type="button"><i class="fa fa-search"></i>Lọc</button>
                                                    &nbsp;
                                                    <button id="btnResetFilter" type="button" class="btn btn-default ng-binding"><i class="fa fa-remove"></i>Bỏ lọc</button>
                                                </div>

                                            </div>
                                        </div>
                                    </div>

                                    <br />
                                    <br />

                                    <table class="table table-responsive">
                                        <thead>
                                            <tr style="background-color:#ddd;text-align:center;vertical-align: middle;">
                                                <td><b>Thời gian</b></td>
                                                <td><b>Lượng thay đổi</b></td>
                                                <td><b>Loại thay đổi</b></td>
                                                <td><b>Trước</b></td>
                                                <td><b>Sau</b></td>
                                                <td><b>Loại điều chỉnh</b></td>
                                                <td><b>Người thay đổi</b></td>
                                                <td><b>Mô tả</b></td>
                                            </tr>
                                        </thead>
                                        <tbody id="tblHistoryData"></tbody>
                                    </table>
                                    <div style="" id="pagination" class="pagination">
                                    </div>
                                </div>
                                <!-- /.tab-pane -->
                                <div class="tab-pane" id="tab_3">

                                </div>
                                <!-- /.tab-pane -->
                            </div>
                            <!-- /.tab-content -->
                        </div>

                        <div>


                        </div>


                    </div>


                </div>

            </div>
            <!-- ./box-body -->

        </div>


    </div>
</section>

<script id="data-template" type="x-tmpl-mustache">
    <tr style="text-align:center;vertical-align: middle;">
        <td>{{TimeAccess}}</td>
        <td>{{Quantity}}</td>
        <td>
            {{TransactionType}}
        </td>
        <td>
            {{BeforeQty}}
        </td>
        <td>
            {{AfterQty}}
        </td>
        <td>
            {{InputType}}
        </td>
        <td>
            {{CreatedBy}}
        </td>
        <td style="width:30%">
            <p style="text-wrap:inherit">
                {{Description}}
            </p>
        </td>
    </tr>
</script>

<script>

    var homeconfig = {
        pageSize: 10,
        pageIndex: 1,
        allShops: [],
        rmId : @Model.Id
    };

    var rawMaterialController = {

        run: function () {
            rawMaterialController.loadData(homeconfig.rmId);

            $('#fromDate').datepicker({
                format: 'dd/mm/yyyy',
            });
            $('#toDate').datepicker({
                format: 'dd/mm/yyyy',
            });
        },
        // register event for elements
        registerEvent: function () {
            // event for search button,

            $('#tab_transactionHistory_huhu').off('click').on('click', function () {
                rawMaterialController.loadData(homeconfig.rmId,true);
            })

            $('#btnSearch').off('click').on('click', function () {
                rawMaterialController.loadData(homeconfig.rmId, true);
            });

            $('#btnResetFilter').off('click').on('click', function () {
                $('#fromDate').val('');
                $('#toDate').val('');
                $('#ddlInputType').val('').change();
                rawMaterialController.loadData(homeconfig.rmId, true);
            })

            $('#btnSave').off('click').on('click', function () {
                var model = {
                    Id : homeconfig.rmId,
                    Name: $('#txtName').val(),
                    RawMaterialUnitId: $('#ddlRawMaterialUnits').val(),
                    Description: $('#txtDescription').val()
                }
                rawMaterialController.updateRw(model);
            });

        },
        updateRw: function (model) {
            $.ajax({
                url: '/RawMaterial/UpdateRawMaterial',
                data: { model: model },
                type: 'post',
                success: function (res) {
                    if (res.status) {
                        toastr.success("Cập nhật thành công...");
                    }
                    else {
                        toastr.error(res.errorMessage);
                    }
                }
            })  
        },
        formatMoney: function (value) {
            var ressult = accounting.formatMoney(value, "", 0, ".", ","); // €4.999,99
            return ressult;
        },
        loadData: function (rmId, changePageSize) {
            homeconfig.allCategories = [];
            $.ajax({
                url: '/RawMaterial/RmHistoriesWithPaging',
                type: 'post',
                dataType: 'json',
                data: {
                        model: {
                            Id: rmId,
                            PageSize: homeconfig.pageSize,
                            PageIndex: homeconfig.pageIndex,
                            StartDate: $('#fromDate').val(),
                            EndDate: $('#toDate').val(),
                            InputTypeId: $('#ddlInputType').val()
                    }
                   },
                success: function (res) {
                    if (res.status) {

                        var paginInfo = "";
                        if (res.data.Items.length > 0) {
                            var begin = (homeconfig.pageIndex - 1) * homeconfig.pageSize + 1;
                            paginInfo = begin + " - " + (begin + res.data.Items.length - 1) + " trên " + res.data.TotalRows + " đơn hàng";
                        }

                        $('#pagingInfo').html(paginInfo);
                        console.log(paginInfo);
                        var data = res.data;
                        var html = '';
                        var template = $('#data-template').html();
                        $.each(data.Items, function (i, item) {
                            html += Mustache.render(template, {
                                TimeAccess: item.TimeAccessDisplay,
                                Quantity: item.Quantity,
                                TransactionType: item.TransactionTypeId == 1 ? "Tăng" : "Giảm",
                                AfterQty: item.TotalQtyAtTimeAccess,
                                BeforeQty: item.OldQty,
                                InputType: function () {
                                    var type = "";
                                    if (item.InputTypeId == 0) {
                                        type = "Thêm hàng mới";
                                    }
                                    else if (item.InputTypeId == 1) {
                                        type = "Điều chỉnh";
                                    }
                                    else {
                                        type = "Tự động trừ";
                                    }
                                    return type;
                                },
                                CreatedBy: item.CreatedBy,
                                Description: item.Description
                            });

                        });
                        $('#tblHistoryData').html(html);
                        try {
                            rawMaterialController.paging(data.TotalRows, function () {
                                rawMaterialController.loadData(homeconfig.rmId);
                            }, changePageSize);
                        } catch (e) {

                        }

                        rawMaterialController.registerEvent();
                    }
                }
            });

        },
        paging: function (totalRow, callback, changePageSize) {
            var totalPage = Math.ceil(totalRow / homeconfig.pageSize);
            //Unbind pagination if it existed or click change pagesize
            if ($('#pagination a').length === 0 || changePageSize === true) {
                $('#pagination').empty();
                $('#pagination').removeData("twbs-pagination");
                $('#pagination').unbind("page");
            }
            $('#pagination').twbsPagination({
                totalPages: totalPage,
                first: "Đầu",
                next: "Tiếp",
                last: "Cuối",
                prev: "Trước",
                visiblePages: 10,
                onPageClick: function (event, page) {
                    homeconfig.pageIndex = page;
                    setTimeout(callback, 200);
                }
            });
        },
    };
    rawMaterialController.run();


</script>